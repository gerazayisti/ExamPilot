// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  school    String?
  role      String?
  createdAt DateTime @default(now())

  // Relations
  settings  Settings?
  rooms     Room[]
  cohorts   Cohort[]
  sessions  PlanningSession[]
  subjects  Subject[]
  exams     Exam[]
  logs      SystemLog[]
}

model SystemLog {
  id        String   @id @default(uuid())
  action    String   // e.g., "LOGIN", "CREATE_EXAM", "GENERATE_SCHEDULE"
  details   String?  // JSON string or description
  ip        String?
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Settings {
  id           String   @id @default(uuid())
  appName      String   @default("ExamPilot")
  logoUrl      String? // Base64 or URL
  primaryColor String   @default("#3b82f6")
  examInterStudentGap Int @default(0) // 0 = no gap, 1 = 1 empty seat between students
  maxExamsPerDay      Int @default(2) // Maximum number of exams a student can take in a day
  maxConsecutiveExams Int @default(2) // Maximum number of consecutive exams without break
  updatedAt    DateTime @updatedAt
  
  userId       String?  @unique
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Room {
  id        String   @id @default(uuid())
  name      String
  capacity  Int
  location  String
  type      String   @default("Salle TD") // Amphithéâtre, Salle TD, Laboratoire
  
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  schedules Schedule[]

  // Explicit unique constraint for upsert per user
  @@unique([name, userId])
}

model Cohort {
  id       String    @id @default(uuid())
  major    String // Filière (ex: Informatique)
  level    String // Niveau (ex: L3)
  size     Int // Nombre d'étudiants
  subjects Subject[]
  
  userId   String?
  user     User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([major, level, userId])
}

model Subject {
  id       String  @id @default(uuid())
  code     String
  title    String
  cohortId String
  cohort   Cohort  @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  exams    Exam[]
  
  userId   String?
  user     User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([code, cohortId])
}

model Exam {
  id        String @id @default(uuid())
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  duration  Int // En minutes
  type      String // DS, Exam, Rattrapage
  
  userId    String?
  user      User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  schedules Schedule[]

  @@unique([subjectId, type])
}

model TimeSlot {
  id        String     @id @default(cuid())
  startTime DateTime
  endTime   DateTime
  schedules Schedule[]
}

model PlanningSession {
  id        String     @id @default(uuid())
  name      String
  createdAt DateTime   @default(now())
  schedules Schedule[]
  
  userId    String?
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Schedule {
  id                String          @id @default(cuid())
  examId            String
  exam              Exam            @relation(fields: [examId], references: [id], onDelete: Cascade)
  roomId            String
  room              Room            @relation(fields: [roomId], references: [id], onDelete: Cascade)
  timeSlotId        String
  timeSlot          TimeSlot        @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)
  planningSessionId String
  planningSession   PlanningSession @relation(fields: [planningSessionId], references: [id], onDelete: Cascade)
}
